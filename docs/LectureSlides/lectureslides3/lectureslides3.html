<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>STAT 302, Week 3</title>
    <meta charset="utf-8" />
    <meta name="author" content="Bryan Martin" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis.css" rel="stylesheet" />
    <link href="libs/remark-css/metropolis-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, top, title-slide

# STAT 302, Week 3
## Data Visualization and Manipulation
### Bryan Martin
### Week of Jan 20, 2020

---





# Outline

1. Introduction to tidyverse
2. Data Visualization
3. Data Manipulation

.middler[**Goal:** Learn how to go from raw data to exploratory data analysis. (Project 1!)]

---
class: inverse

.sectionhead[Part 1: Introduction to tidyverse]
---
layout: true

# tidyverse
---

The `tidyverse` is a collection of powerful R packages for data science. 
They include:

* Reading and saving data: `readr`
* Data manipulation: `tidyr`, `dplyr`
* Data visualization: `ggplot2`
* Working with different data structures: `tibble`, `purrr`, `stringr`, `forcats`

You can install them all using


```r
install.packages("tidyverse")
```

(Remember, you only need to do this once!)

---

Load them all together in your workflow documents by calling


```r
library(tidyverse)
```

---

## Conflicts?

Recall that packages are essentially ways for you to install and use functions 
written by others.
Occasionally, some of these functions have the same name and there is a conflict.
Whichever package you load more recently using `library` will mask the old function, meaning that R will default to that version.

In general, this is fine, especially with `tidyverse`. These package authors know when 
they have masked common functions in R, and typically we will prefer `tidyverse` version.

The conflict message is to make sure you know about conflicts. 
You can (and should) hide this in your R Markdown files by adding the parameter
`message=FALSE` or `include=FALSE` to your code chunk when you load packages.

---
layout: false
layout: true

# Pipes
---

.sectionhead[![pipe](pipe.png)]

---


**pipes** use the `%&gt;%` operator to take the output from a previous function call and "pipe" it through to the next function.
This can really help with readability of code when we use multiple nested functions!

We will use the `gapminder` data from Jenny Bryan to demonstrate throughout this section.
Load the package `gapminder` (after installing) and the corresponding data.


```r
library(gapminder)
data(gapminder)
```

Let's preview the data.


```r
gapminder
```

```
## # A tibble: 1,704 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333      779.
##  2 Afghanistan Asia       1957    30.3  9240934      821.
##  3 Afghanistan Asia       1962    32.0 10267083      853.
##  4 Afghanistan Asia       1967    34.0 11537966      836.
##  5 Afghanistan Asia       1972    36.1 13079460      740.
##  6 Afghanistan Asia       1977    38.4 14880372      786.
##  7 Afghanistan Asia       1982    39.9 12881816      978.
##  8 Afghanistan Asia       1987    40.8 13867957      852.
##  9 Afghanistan Asia       1992    41.7 16317921      649.
## 10 Afghanistan Asia       1997    41.8 22227415      635.
## # … with 1,694 more rows
```


---

## A brief note on factors


```r
str(gapminder)
```

```
## Classes 'tbl_df', 'tbl' and 'data.frame':	1704 obs. of  6 variables:
##  $ country  : Factor w/ 142 levels "Afghanistan",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ continent: Factor w/ 5 levels "Africa","Americas",..: 3 3 3 3 3 3 3 3 3 3 ...
##  $ year     : int  1952 1957 1962 1967 1972 1977 1982 1987 1992 1997 ...
##  $ lifeExp  : num  28.8 30.3 32 34 36.1 ...
##  $ pop      : int  8425333 9240934 10267083 11537966 13079460 14880372 12881816 13867957 16317921 22227415 ...
##  $ gdpPercap: num  779 821 853 836 740 ...
```

**factors** are categorical data that use integer representation.

This can be efficient to store character vectors, because each string is only entered once. 
Because of this, creating data frames (but not tibbles!) in R often default to set strings as factors. 
However, it can also get annoying! 
Factors limit the categories, or `levels`, of the vector, which is often not appropriate.
I usually turn this off by setting the parameter `stringsAsFactors = FALSE` when I use `data.frame()`, unless I specifically want my data encoded as categorical.

---

## Functions in Functions

What if we want the mean log population within our data set? 
Using base R, we might type


```r
mean(log(gapminder$pop))
```

```
## [1] 15.76611
```

With pipes, we can use


```r
gapminder$pop %&gt;%
  log() %&gt;%
  mean()
```

```
## [1] 15.76611
```

Both of these are acceptable. However, when we start adding more and more functions,
pipes can make your code much easier and more natural to read.

---
layout: false

# filtering data

Very commonly, we will want to filter our data to restrict what we plot or analyze.
For example, what if we are only interested in data from China since 1970?


```r
china_1980 &lt;- gapminder %&gt;% 
  filter(country == "China" &amp;
           year &gt;= 1970)
china_1980
```

```
## # A tibble: 8 x 6
##   country continent  year lifeExp        pop gdpPercap
##   &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;      &lt;int&gt;     &lt;dbl&gt;
## 1 China   Asia       1972    63.1  862030000      677.
## 2 China   Asia       1977    64.0  943455000      741.
## 3 China   Asia       1982    65.5 1000281000      962.
## 4 China   Asia       1987    67.3 1084035000     1379.
## 5 China   Asia       1992    68.7 1164970000     1656.
## 6 China   Asia       1997    70.4 1230075000     2289.
## 7 China   Asia       2002    72.0 1280400000     3119.
## 8 China   Asia       2007    73.0 1318683096     4959.
```

---
class: inverse

.sectionhead[Part 2: Data Visualization]
---
layout: true

# Data Visualization
---

`ggplot2` is a fantastic way to make complex publication quality&lt;sup&gt;1&lt;/sup&gt; images
without much pre-processing of your data.
Plots are built sequentially using layers, so it's easy to edit and fine-tune the plots you generate.

When using `ggplot2`, it is *essential* that your data are tidy!
If they are not, the functions probably will not look like you expect.

Let's work through how to build a plot layer by layer.

.footnote[[1] or STAT302 Project quality]

---

First, let's initialize a plot. Use the `data` parameter to tell `ggplot` what data frame to use.

* It should be tidy data, in either a `data.frame` or `tibble`!

.pull-left[

```r
*ggplot(data = gapminder)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;
]

---

Add an aesthetic using the function `aes()` within the initial `ggplot()` call.

* Controls our axes variables as well as graphical parameters such as color, size, shape

.pull-left[

```r
ggplot(data = gapminder,
*      aes(x = year, y = lifeExp))
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-12-1.png)&lt;!-- --&gt;
]

---

Now `ggplot` knows what to plot, but it doesn't know how to plot it yet. Let's add some points with `geom_point()`.

* This is a new layer! We add layers using the `+` operator.


.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
* geom_point()
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-14-1.png)&lt;!-- --&gt;
]

---

Let's make our points smaller and red.

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
* geom_point(color = "red", size = 0.75)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;
]

---

Let's try switching them to lines.

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp)) +
* geom_line(color = "red", size = 0.75)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-18-1.png)&lt;!-- --&gt;
]

---

We want lines connected by country, not just in the order they appear in the data.

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
*          group = country)) +
  geom_line(color = "red", size = 0.5) 
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-20-1.png)&lt;!-- --&gt;
]

---

We want to explore differences across continents, so let's color by continent

* We use `aes()` because we want to color by something in our data
* Putting a color within `aes()` will automatically add a label
* We have to remove the color within `geom_line()`, or it will override the `aes()`


.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
*          color = continent)) +
* geom_line(size = 0.5)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-22-1.png)&lt;!-- --&gt;
]

---

Let's add another layer. Trendlines by continent!

* We want them grouped differently than our lines (by continent), so we use a new `aes()`
* We will make them stick out by having them be thicker and black
* We don't want error bars, so we will remove `se`
* We will use the default option `loess`. (See `?geom_smooth()`)

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
* geom_smooth(aes(group = continent),
*             se = FALSE, size = 1.5,
*             color = "black",
*             method = "loess")
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-24-1.png)&lt;!-- --&gt;
]

---


This is cluttered and hard to read. Let's try separating by continents using **facets**!

* We use `facet_wrap` 
* Takes in a **formula** object. Use a tilde `~` and then the variable name you want

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, 
              color = "black", 
              method = "loess") +
* facet_wrap(~ continent)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-26-1.png)&lt;!-- --&gt;
]

---

Looking better! Now let's fine tune. First we'll formalize the labels on our plot using `labs()`.

* Can also edit labels one at a time using `xlab()`, `ylab()`, `ggmain()`, ...
* You should probably do this in every graph you present! Very rarely do you want the text styling of your data frame to match your output. Emphasis here on human readability!


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, 
              color = "black", 
              method = "loess") +
  facet_wrap(~ continent) +
* labs(title = "Life expectancy over time by continent",
*      x = "Year", y = "Life Expectancy",
*      legend = "Continent")
```

---

![](lectureslides3_files/figure-html/unnamed-chunk-28-1.png)&lt;!-- --&gt;


---

Let's center our title by adjusting `theme()`.

* `element_text()` tells ggplot how to display the text. Used for fine-tuning
* `hjust` is our horizontal alignment, we set it to one half



```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy", legend = "Continent") +
* theme(plot.title = element_text(hjust = 0.5,
*                                 face = "bold",
*                                 size = 14))
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-30-1.png)&lt;!-- --&gt;
]

---

Actually, that legend is redundant. Let's remove it.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
*       legend.position = "none")
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-32-1.png)&lt;!-- --&gt;
]

---

I don't like the default gray background. I almost always set the `theme_bw()`.

* There are several other theme options! Too many to list, so look them up if you want more options.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        legend.position = "none") +
* theme_bw()
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-34-1.png)&lt;!-- --&gt;
]

---

This overwrote our custome `theme()` settings! Let's reorder the layers.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
* theme_bw() +
* theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
*       legend.position = "none")
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-36-1.png)&lt;!-- --&gt;
]

---

We can make this more readable. Be careful of text that is too small! 
Let's increase all of our text proportionally using `base_size` within `theme_bw()`.

* We could also do this by adjusting `text` within `theme()`
* Note that we no longer need to manually adjust our title size. This will scale everything automatically.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
* theme_bw(base_size = 16) +
* theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.position = "none") 
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-38-1.png)&lt;!-- --&gt;
]


---

Almost there! Now our text is a good size, but it overlaps. There are a few ways we could fix this. We'll rotate our text.



```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme_bw(base_size = 16) + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), 
        legend.position = "none",
*       axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-40-1.png)&lt;!-- --&gt;
]

---

Lastly, let's space out our panels by adjusting `panel.spacing.x`.


```r
ggplot(data = gapminder,
       aes(x = year, y = lifeExp,
           group = country,
           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme_bw(base_size = 16) + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), 
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
*       panel.spacing.x = unit(0.75, "cm"))
```

---

.middler[
![](lectureslides3_files/figure-html/unnamed-chunk-42-1.png)&lt;!-- --&gt;
]

---

Great, that looks good! Now we can store it as an object.


```r
*lifeExp_plot &lt;- ggplot(data = gapminder,
                       aes(x = year, y = lifeExp,
                           group = country,
                           color = continent)) + 
  geom_line(size = 0.5) +
  geom_smooth(aes(group = continent), 
              se = FALSE, size = 1.5, color = "black", method = "loess") +
  facet_wrap(~ continent) +
  labs(title = "Life expectancy over time by continent", 
       x = "Year", y = "Life Expectancy") +
  theme_bw(base_size = 16) + 
  theme(plot.title = element_text(hjust = 0.5, face = "bold"), 
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        panel.spacing.x = unit(0.75, "cm")) 
```

---

Then we can plot it by just calling our object.


```r
lifeExp_plot
```

.center[
![](lectureslides3_files/figure-html/unnamed-chunk-45-1.png)&lt;!-- --&gt;
]

---


We can also save it in our `Figures` subfolder using `ggsave()`.

* Set `height` and `width` parameters to automatically resize the image



```r
ggsave(filename = "Figures/lifeExp_plot.pdf", plot = lifeExp_plot,
       height = 5, width = 7)
```

.center[**Never** save a figure from your analysis using screenshots or point-and-click!

They will be lower quality and non-reproducible!]

---

## Some comments on `ggplot`:

* What we just made was a *very* complicated and fine-tuned plot!
* I have to Google how to adjust certain things all the time
* So does the creator of `ggplot2`

.center[![hadley](hadley.png)]

---

## A simpler example: Histogram

.pull-left[

```r
*ggplot(data = gapminder,
*      aes(x = lifeExp))
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-48-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
* geom_histogram()
```
]

.pull-right[

```
## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
```

![](lectureslides3_files/figure-html/unnamed-chunk-50-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
* geom_histogram(binwidth = 1)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-52-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
  geom_histogram(binwidth = 1, 
*                color = "black",
*                fill = "lightblue")
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-54-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
  geom_histogram(binwidth = 1, 
                 color = "black", 
                 fill = "lightblue") +
* theme_bw(base_size = 20)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-56-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Histogram

.pull-left[

```r
ggplot(data = gapminder,
       aes(x = lifeExp)) + 
  geom_histogram(binwidth = 1, 
                 color = "black", 
                 fill = "lightblue") +
  theme_bw(base_size = 20) +
* labs(x = "Life Expectancy",
*      y = "Count")
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-58-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
*ggplot(data = gapminder,
*      aes(x = continent, y = lifeExp))
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-60-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
* geom_boxplot()
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-62-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
* geom_boxplot(fill = "lightblue")
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-64-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
* theme_bw(base_size = 20)
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-66-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
  theme_bw(base_size = 20) +
* labs(title = "Life expectancy by Continent",
*      x = "",
*      y = "")
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-68-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
  theme_bw(base_size = 20) +
  labs(title = "Life expectancy by Continent", 
       x = "", 
       y = "") +
* theme(plot.title =
*         element_text(hjust = 0.5))
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-70-1.png)&lt;!-- --&gt;
]

---

## A simpler example: Boxplots

.pull-left[

```r
ggplot(data = gapminder, 
       aes(x = continent, y = lifeExp)) +
  geom_boxplot(fill = "lightblue") +
  theme_bw(base_size = 20) +
  labs(title = "Life expectancy by Continent", 
       x = "", 
       y = "") +
  theme(plot.title =
          element_text(hjust = 0.5)) +
* ylim(c(0, 85))
```
]

.pull-right[
![](lectureslides3_files/figure-html/unnamed-chunk-72-1.png)&lt;!-- --&gt;
]

---

.pull-left[## Don'ts
* Pie graphs, ever
* 3D plots
* Deceptive axes
* Excessive labels
* Excessive/bad coloring
* Fancy shading/effects
* Bad variable/axis names
* Unreadable labels
* Overloaded with information
]

.pull-right[## Do's
* Simple, clean graphics
* Neat and human readable text
* Appropriate data range (bar charts should *always* start from 0!)
* Consistent intervals
* Roughly ~6 colors or less
* Size figures appropriately
]

---
layout: false
layout: true

# Bad Visualizations!

---

.center[&lt;img src="bad1.jpg" alt="" height="300"/&gt;]

--

**No-no:** Pie charts! Eugh! The proportions are completely off!
.pull-right[.center[&lt;img src="gag1.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad2.jpg" alt="" height="300"/&gt;]

--

**No-no:** Pie charts! Eugh! Percents don't add up!
.pull-right[.center[&lt;img src="gag2.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad3.png" alt="" height="300"/&gt;]

--

**No-no:** 3d bar charts?!
.pull-right[.center[&lt;img src="gag3.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad4.png" alt="" height="300"/&gt;]

--

**No-no:** Bad use of color
.pull-right[.center[&lt;img src="gag4.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad5.jpg" alt="" height="300"/&gt;]

--

**No-no:** Bad axis, lack of information, 3D bar chart
.pull-right[.center[&lt;img src="gag5.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad6.jpg" alt="" height="300"/&gt;]

--

**No-no:** Four numbers displayed as a cluttered chart, terrible labels, bad axis range
.pull-right[.center[&lt;img src="gag6.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad7.jpg" alt="" height="300"/&gt;]

--

**No-no:** Deceptively flipped y-axis! (and excessive color)
.pull-right[.center[&lt;img src="gag7.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad8.jpg" alt="" height="300"/&gt;]
.center[(This was presented in congress!)]

--

**No-no:** Two axes in a single plot, bad axis range
.pull-right[.center[&lt;img src="gag8.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad9.png" alt="" height="300"/&gt;]

--

**No-no:** Deceptive axis range (should start at 0)
.pull-right[.center[&lt;img src="gag9.gif" alt="" height="200"/&gt;]]

---

.center[&lt;img src="bad10.png" alt="" height="300"/&gt;]
.center[(From the Gates Foundation!)]

--

**No-no:** Inconsistent x-axis intervals
.pull-right[.center[&lt;img src="gag10.gif" alt="" height="200"/&gt;]]

---
layout: false

# ggplot cheatsheet

* Axes: `xlim()`, `ylim()`
* Legends: within initial `aes()`, edit within `theme()` or `guides()`
* `geom_point()`, `geom_line()`, `geom_histogram()`, `geom_bar()`, `geom_boxplot()`, `geom_text()`
* `facet_grid()`, `facet_wrap()` for faceting
* `labs()` for labels
* `theme_bw()` to make things look nicer
* Graphical parameters: `color` for color, `alpha` for opacity, `lwd`/`size` for thickness, `shape` for shape, `fill` for interior color, ...

.pushdown[.center[[Much, much more! (Click me for a cheat sheet!)](https://rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)]]

---
class: inverse

.sectionhead[Part 3: Data Manipulation]

---
layout: true

# &lt;TT&gt;select()&lt;/TT&gt;: Column selection

---

Use `select()` to choose certain columns.


```r
gapminder %&gt;% 
  select(lifeExp, gdpPercap)
```

```
## # A tibble: 1,704 x 2
##    lifeExp gdpPercap
##      &lt;dbl&gt;     &lt;dbl&gt;
##  1    28.8      779.
##  2    30.3      821.
##  3    32.0      853.
##  4    34.0      836.
##  5    36.1      740.
##  6    38.4      786.
##  7    39.9      978.
##  8    40.8      852.
##  9    41.7      649.
## 10    41.8      635.
## # … with 1,694 more rows
```

---
Use `select()` to choose certain columns.
We can also use `select()` to remove certain columns by putting a `-` symbol in front.


```r
gapminder %&gt;% 
  select(-lifeExp, -gdpPercap)
```

```
## # A tibble: 1,704 x 4
##    country     continent  year      pop
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;    &lt;int&gt;
##  1 Afghanistan Asia       1952  8425333
##  2 Afghanistan Asia       1957  9240934
##  3 Afghanistan Asia       1962 10267083
##  4 Afghanistan Asia       1967 11537966
##  5 Afghanistan Asia       1972 13079460
##  6 Afghanistan Asia       1977 14880372
##  7 Afghanistan Asia       1982 12881816
##  8 Afghanistan Asia       1987 13867957
##  9 Afghanistan Asia       1992 16317921
## 10 Afghanistan Asia       1997 22227415
## # … with 1,694 more rows
```

---
## Helper functions

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings


```r
gapminder %&gt;%
  select(starts_with("co")) %&gt;%
  head()
```

```
## # A tibble: 6 x 2
##   country     continent
##   &lt;fct&gt;       &lt;fct&gt;    
## 1 Afghanistan Asia     
## 2 Afghanistan Asia     
## 3 Afghanistan Asia     
## 4 Afghanistan Asia     
## 5 Afghanistan Asia     
## 6 Afghanistan Asia
```

---

## Helper functions

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings


```r
gapminder %&gt;%
  select(ends_with("p")) %&gt;%
  head()
```

```
## # A tibble: 6 x 3
##   lifeExp      pop gdpPercap
##     &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
## 1    28.8  8425333      779.
## 2    30.3  9240934      821.
## 3    32.0 10267083      853.
## 4    34.0 11537966      836.
## 5    36.1 13079460      740.
## 6    38.4 14880372      786.
```

---

## Helper functions

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings


```r
gapminder %&gt;%
  select(contains("Per")) %&gt;%
  head()
```

```
## # A tibble: 6 x 1
##   gdpPercap
##       &lt;dbl&gt;
## 1      779.
## 2      821.
## 3      853.
## 4      836.
## 5      740.
## 6      786.
```
---

## Helper functions

`select()` has a number of helper functions to select columns (see `?select`).
Notably:
* `starts_with()` for prefixes
* `ends_with()` for suffixes
* `contains()` for strings

This can be particularly helpful when you have data in "wide" format! (such as `category_01`, `category_02`, `category_03`, ...)


---
layout: false
layout: true

# &lt;TT&gt;mutate()&lt;/TT&gt;: create new columns


Create and transform variables from existing variables using `mutate()`. 

Syntax follows `NEW_VAR_NAME = ...`.

---


```r
gapminder %&gt;%
  mutate(gdp = gdpPercap * pop) %&gt;%
  head()
```

```
## # A tibble: 6 x 7
##   country     continent  year lifeExp      pop gdpPercap          gdp
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;        &lt;dbl&gt;
## 1 Afghanistan Asia       1952    28.8  8425333      779.  6567086330.
## 2 Afghanistan Asia       1957    30.3  9240934      821.  7585448670.
## 3 Afghanistan Asia       1962    32.0 10267083      853.  8758855797.
## 4 Afghanistan Asia       1967    34.0 11537966      836.  9648014150.
## 5 Afghanistan Asia       1972    36.1 13079460      740.  9678553274.
## 6 Afghanistan Asia       1977    38.4 14880372      786. 11697659231.
```

---

Note that we can use existing columns, including those we created within the same call to `mutate()`.


```r
gapminder %&gt;%
  mutate(gdp = gdpPercap * pop) %&gt;%
  mutate(logGDP = log(gdp)) %&gt;% 
  head()
```

```
## # A tibble: 6 x 8
##   country     continent  year lifeExp      pop gdpPercap          gdp logGDP
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;        &lt;dbl&gt;  &lt;dbl&gt;
## 1 Afghanistan Asia       1952    28.8  8425333      779.  6567086330.   22.6
## 2 Afghanistan Asia       1957    30.3  9240934      821.  7585448670.   22.7
## 3 Afghanistan Asia       1962    32.0 10267083      853.  8758855797.   22.9
## 4 Afghanistan Asia       1967    34.0 11537966      836.  9648014150.   23.0
## 5 Afghanistan Asia       1972    36.1 13079460      740.  9678553274.   23.0
## 6 Afghanistan Asia       1977    38.4 14880372      786. 11697659231.   23.2
```

---
layout: false
layout: true
# &lt;TT&gt;ifelse()&lt;/TT&gt;: conditional selection

---

`ifelse()` takes in a logical test and conditional responses, and returns a vector of values based on the output of the test. It can be very useful for data cleaning (among other uses)!

`ifelse(test, yes, no)`

* `test`: the logical test
* `yes`: return values for when `test` is `TRUE`
* `no`: return values for when `test` is `FALSE`


```r
demo &lt;- -2:2
ifelse(demo &gt; 0, "strictly positive", "not strictly positive")
```

```
## [1] "not strictly positive" "not strictly positive" "not strictly positive"
## [4] "strictly positive"     "strictly positive"
```

---

`ifelse()` can be very useful within `mutate()`.
For example, if we want to use the country code `USA` instead of `United States`, and store this variable as `country_clean`, we can use:


```r
gapminder %&gt;%
  mutate(country_clean =
           ifelse(country == "United States",
                  "USA", as.character(country))) %&gt;%
  filter(year == 2007,
         continent == "Americas") %&gt;%
  select(country, country_clean, lifeExp, gdpPercap) %&gt;%
  tail()
```

```
## # A tibble: 6 x 4
##   country             country_clean       lifeExp gdpPercap
##   &lt;fct&gt;               &lt;chr&gt;                 &lt;dbl&gt;     &lt;dbl&gt;
## 1 Peru                Peru                   71.4     7409.
## 2 Puerto Rico         Puerto Rico            78.7    19329.
## 3 Trinidad and Tobago Trinidad and Tobago    69.8    18009.
## 4 United States       USA                    78.2    42952.
## 5 Uruguay             Uruguay                76.4    10611.
## 6 Venezuela           Venezuela              73.7    11416.
```

---
layout: false
layout: true
# &lt;TT&gt;%in%&lt;/TT&gt;: value matching

`%in%` is a binary operator, which returns a boolean vector indicating whether
components in the left-hand side are found in the right-hand side.

---


```r
1 %in% 1:5
```

```
## [1] TRUE
```

```r
1 %in% -1:-5
```

```
## [1] FALSE
```

```r
c(0, 1, 2, 7) %in% 1:5
```

```
## [1] FALSE  TRUE  TRUE FALSE
```

---

To negate the `%in%` operator, wrap the entire logical statement within `!(...)`.


```r
!(1 %in% 1:5)
```

```
## [1] FALSE
```

```r
!(1 %in% -1:-5)
```

```
## [1] TRUE
```

```r
!(c(0, 1, 2, 7) %in% 1:5)
```

```
## [1]  TRUE FALSE FALSE  TRUE
```


---


```r
gapminder %&gt;%
  filter(continent %in% c("Americas", "Europe")) %&gt;%
  filter(year %in% c(2002, 2007)) %&gt;%
  head()
```

```
## # A tibble: 6 x 6
##   country   continent  year lifeExp      pop gdpPercap
##   &lt;fct&gt;     &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
## 1 Albania   Europe     2002    75.7  3508512     4604.
## 2 Albania   Europe     2007    76.4  3600523     5937.
## 3 Argentina Americas   2002    74.3 38331121     8798.
## 4 Argentina Americas   2007    75.3 40301927    12779.
## 5 Austria   Europe     2002    79.0  8148312    32418.
## 6 Austria   Europe     2007    79.8  8199783    36126.
```

---
layout: false
layout: true
# split-apply-combine

---
*split-apply-combine* is a data analysis strategy where you *split* the data up into pieces, *apply* some operation on each piece, and then *combine* all the pieces back together. 
It's useful for breaking big problems into smaller manageable chunks!

---

## `group_by()`

You can use `group_by()` to define a grouping of the rows of your data based on the columns.

Notice that it doesn't change our data, except for that we can now see that it has 5 groups.


```r
grouped_gap &lt;- gapminder %&gt;%
  group_by(continent)
head(grouped_gap, 3)
```

```
## # A tibble: 3 x 6
## # Groups:   continent [1]
##   country     continent  year lifeExp      pop gdpPercap
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
## 1 Afghanistan Asia       1952    28.8  8425333      779.
## 2 Afghanistan Asia       1957    30.3  9240934      821.
## 3 Afghanistan Asia       1962    32.0 10267083      853.
```

```r
class(grouped_gap)
```

```
## [1] "grouped_df" "tbl_df"     "tbl"        "data.frame"
```

---

## `group_by()`

You can use `group_by()` to define a grouping of the rows of your data based on the columns.

We can remove the groups with `ungroup()`.


```r
ungrouped_gap &lt;- ungroup(grouped_gap)
head(ungrouped_gap, 4)
```

```
## # A tibble: 4 x 6
##   country     continent  year lifeExp      pop gdpPercap
##   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
## 1 Afghanistan Asia       1952    28.8  8425333      779.
## 2 Afghanistan Asia       1957    30.3  9240934      821.
## 3 Afghanistan Asia       1962    32.0 10267083      853.
## 4 Afghanistan Asia       1967    34.0 11537966      836.
```

```r
class(ungrouped_gap)
```

```
## [1] "tbl_df"     "tbl"        "data.frame"
```

---

## `summarize()`

`summarize()` (or `summarise()`, if you prefer) will apply functions to rows of a data frame. If a data frame is grouped, the function will be applied by group.


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(mean_lifeExp = mean(lifeExp, na.rm = TRUE),
            max_gdp = max(gdpPercap))
```

```
## # A tibble: 5 x 3
##   continent mean_lifeExp max_gdp
##   &lt;fct&gt;            &lt;dbl&gt;   &lt;dbl&gt;
## 1 Africa            48.9  21951.
## 2 Americas          64.7  42952.
## 3 Asia              60.1 113523.
## 4 Europe            71.9  49357.
## 5 Oceania           74.3  34435.
```

Notice that this creates an entirely new (and much smaller) data frame. Typically we want to store this object as a variable, but not as the same variable as our data!

---

## `arrange()`

We can order the rows of the data using `arrange()`. Usually, you do this after some call to `summarize()`. 


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(mean_lifeExp = mean(lifeExp, na.rm = TRUE),
            max_gdp = max(gdpPercap)) %&gt;%
  arrange(mean_lifeExp)
```

```
## # A tibble: 5 x 3
##   continent mean_lifeExp max_gdp
##   &lt;fct&gt;            &lt;dbl&gt;   &lt;dbl&gt;
## 1 Africa            48.9  21951.
## 2 Asia              60.1 113523.
## 3 Americas          64.7  42952.
## 4 Europe            71.9  49357.
## 5 Oceania           74.3  34435.
```

---

## `arrange()`

We can order the rows of the data using `arrange()`. Usually, you do this after some call to `summarize()`. We can use `desc()` to put in decreasing order.


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(mean_lifeExp = mean(lifeExp, na.rm = TRUE),
            max_gdp = max(gdpPercap)) %&gt;%
  arrange(desc(mean_lifeExp))
```

```
## # A tibble: 5 x 3
##   continent mean_lifeExp max_gdp
##   &lt;fct&gt;            &lt;dbl&gt;   &lt;dbl&gt;
## 1 Oceania           74.3  34435.
## 2 Europe            71.9  49357.
## 3 Americas          64.7  42952.
## 4 Asia              60.1 113523.
## 5 Africa            48.9  21951.
```


---

## `count()`

If we want to count by groups, we can use the notation we've already earned.


```r
gapminder %&gt;%
  group_by(continent) %&gt;%
  summarize(count = n())
```

```
## # A tibble: 5 x 2
##   continent count
##   &lt;fct&gt;     &lt;int&gt;
## 1 Africa      624
## 2 Americas    300
## 3 Asia        396
## 4 Europe      360
## 5 Oceania      24
```

---

## `count()`

Alternatively, we can use the shorthand `count()`, with optional argument `sort` to order.


```r
gapminder %&gt;%
  count(continent, sort = FALSE)
```

```
## # A tibble: 5 x 2
##   continent     n
##   &lt;fct&gt;     &lt;int&gt;
## 1 Africa      624
## 2 Americas    300
## 3 Asia        396
## 4 Europe      360
## 5 Oceania      24
```

---

## `count()`

We can also count combinations of categories by supplying multiple variables to `count()`.


```r
gapminder %&gt;%
  count(continent, country)
```

```
## # A tibble: 142 x 3
##    continent country                      n
##    &lt;fct&gt;     &lt;fct&gt;                    &lt;int&gt;
##  1 Africa    Algeria                     12
##  2 Africa    Angola                      12
##  3 Africa    Benin                       12
##  4 Africa    Botswana                    12
##  5 Africa    Burkina Faso                12
##  6 Africa    Burundi                     12
##  7 Africa    Cameroon                    12
##  8 Africa    Central African Republic    12
##  9 Africa    Chad                        12
## 10 Africa    Comoros                     12
## # … with 132 more rows
```

---

## `count()`

We can also count combinations of categories by supplying multiple variables to `count()`, we can then sort using `arrange()`.


```r
gapminder %&gt;%
  count(continent, country) %&gt;%
  arrange(country, desc(n))
```

```
## # A tibble: 142 x 3
##    continent country         n
##    &lt;fct&gt;     &lt;fct&gt;       &lt;int&gt;
##  1 Asia      Afghanistan    12
##  2 Europe    Albania        12
##  3 Africa    Algeria        12
##  4 Africa    Angola         12
##  5 Americas  Argentina      12
##  6 Oceania   Australia      12
##  7 Europe    Austria        12
##  8 Asia      Bahrain        12
##  9 Asia      Bangladesh     12
## 10 Europe    Belgium        12
## # … with 132 more rows
```


---
layout:false 

# &lt;TT&gt;pull()&lt;/TT&gt;: extract column as vector

You can use `pull()` to extract a single column as a vector. Notice the difference between


```r
gapminder %&gt;%
  select(lifeExp) %&gt;%
  head(4)
```

```
## # A tibble: 4 x 1
##   lifeExp
##     &lt;dbl&gt;
## 1    28.8
## 2    30.3
## 3    32.0
## 4    34.0
```


```r
gapminder %&gt;%
  pull(lifeExp) %&gt;%
  head(10)
```

```
##  [1] 28.801 30.332 31.997 34.020 36.088 38.438 39.854 40.822 41.674 41.763
```


---
# &lt;TT&gt;rename()&lt;/TT&gt;: ...renaming!

`rename()` follows the syntax `rename(data, NEW_VAR_NAME = OLD_VAR_NAME)`


```r
gapminder %&gt;%
  rename(life_exp = lifeExp)
```

```
## # A tibble: 1,704 x 6
##    country     continent  year life_exp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;    &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952     28.8  8425333      779.
##  2 Afghanistan Asia       1957     30.3  9240934      821.
##  3 Afghanistan Asia       1962     32.0 10267083      853.
##  4 Afghanistan Asia       1967     34.0 11537966      836.
##  5 Afghanistan Asia       1972     36.1 13079460      740.
##  6 Afghanistan Asia       1977     38.4 14880372      786.
##  7 Afghanistan Asia       1982     39.9 12881816      978.
##  8 Afghanistan Asia       1987     40.8 13867957      852.
##  9 Afghanistan Asia       1992     41.7 16317921      649.
## 10 Afghanistan Asia       1997     41.8 22227415      635.
## # … with 1,694 more rows
```


---
layout: true

# Re-arranging Data

---

## `pivot_longer()`

Let's load the `relig_income` data from tidyverse.


```r
data(relig_income)
head(relig_income)
```

```
## # A tibble: 6 x 11
##   religion `&lt;$10k` `$10-20k` `$20-30k` `$30-40k` `$40-50k` `$50-75k` `$75-100k`
##   &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
## 1 Agnostic      27        34        60        81        76       137        122
## 2 Atheist       12        27        37        52        35        70         73
## 3 Buddhist      27        21        30        34        33        58         62
## 4 Catholic     418       617       732       670       638      1116        949
## 5 Don’t k…      15        14        15        11        10        35         21
## 6 Evangel…     575       869      1064       982       881      1486        949
## # … with 3 more variables: `$100-150k` &lt;dbl&gt;, `&gt;150k` &lt;dbl&gt;, `Don't
## #   know/refused` &lt;dbl&gt;
```

---

## `pivot_longer()`

We can use `pivot_longer()` to go from data in "wide" form to data in "long" form.


```r
relig_income %&gt;%
  pivot_longer(contains("$"), names_to = "income",  values_to = "count")
```

```
## # A tibble: 144 x 5
##    religion `&gt;150k` `Don't know/refused` income    count
##    &lt;chr&gt;      &lt;dbl&gt;                &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
##  1 Agnostic      84                   96 &lt;$10k        27
##  2 Agnostic      84                   96 $10-20k      34
##  3 Agnostic      84                   96 $20-30k      60
##  4 Agnostic      84                   96 $30-40k      81
##  5 Agnostic      84                   96 $40-50k      76
##  6 Agnostic      84                   96 $50-75k     137
##  7 Agnostic      84                   96 $75-100k    122
##  8 Agnostic      84                   96 $100-150k   109
##  9 Atheist       74                   76 &lt;$10k        12
## 10 Atheist       74                   76 $10-20k      27
## # … with 134 more rows
```

---

## `pivot_longer()`

Looks like we missed a few of the income column names. Let's use matches with a regular expression.


```r
relig_income %&gt;%
  pivot_longer(matches("\\$|150|refused"), 
               names_to = "income",  values_to = "count")
```

```
## # A tibble: 180 x 3
##    religion income             count
##    &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;
##  1 Agnostic &lt;$10k                 27
##  2 Agnostic $10-20k               34
##  3 Agnostic $20-30k               60
##  4 Agnostic $30-40k               81
##  5 Agnostic $40-50k               76
##  6 Agnostic $50-75k              137
##  7 Agnostic $75-100k             122
##  8 Agnostic $100-150k            109
##  9 Agnostic &gt;150k                 84
## 10 Agnostic Don't know/refused    96
## # … with 170 more rows
```

---
## `pivot_longer()`

Let's load the `billboard` data from tidyverse.


```r
data(billboard)
billboard
```

```
## # A tibble: 317 x 79
##    artist track date.entered   wk1   wk2   wk3   wk4   wk5   wk6   wk7   wk8
##    &lt;chr&gt;  &lt;chr&gt; &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 2 Pac  Baby… 2000-02-26      87    82    72    77    87    94    99    NA
##  2 2Ge+h… The … 2000-09-02      91    87    92    NA    NA    NA    NA    NA
##  3 3 Doo… Kryp… 2000-04-08      81    70    68    67    66    57    54    53
##  4 3 Doo… Loser 2000-10-21      76    76    72    69    67    65    55    59
##  5 504 B… Wobb… 2000-04-15      57    34    25    17    17    31    36    49
##  6 98^0   Give… 2000-08-19      51    39    34    26    26    19     2     2
##  7 A*Tee… Danc… 2000-07-08      97    97    96    95   100    NA    NA    NA
##  8 Aaliy… I Do… 2000-01-29      84    62    51    41    38    35    35    38
##  9 Aaliy… Try … 2000-03-18      59    53    38    28    21    18    16    14
## 10 Adams… Open… 2000-08-26      76    76    74    69    68    67    61    58
## # … with 307 more rows, and 68 more variables: wk9 &lt;dbl&gt;, wk10 &lt;dbl&gt;,
## #   wk11 &lt;dbl&gt;, wk12 &lt;dbl&gt;, wk13 &lt;dbl&gt;, wk14 &lt;dbl&gt;, wk15 &lt;dbl&gt;, wk16 &lt;dbl&gt;,
## #   wk17 &lt;dbl&gt;, wk18 &lt;dbl&gt;, wk19 &lt;dbl&gt;, wk20 &lt;dbl&gt;, wk21 &lt;dbl&gt;, wk22 &lt;dbl&gt;,
## #   wk23 &lt;dbl&gt;, wk24 &lt;dbl&gt;, wk25 &lt;dbl&gt;, wk26 &lt;dbl&gt;, wk27 &lt;dbl&gt;, wk28 &lt;dbl&gt;,
## #   wk29 &lt;dbl&gt;, wk30 &lt;dbl&gt;, wk31 &lt;dbl&gt;, wk32 &lt;dbl&gt;, wk33 &lt;dbl&gt;, wk34 &lt;dbl&gt;,
## #   wk35 &lt;dbl&gt;, wk36 &lt;dbl&gt;, wk37 &lt;dbl&gt;, wk38 &lt;dbl&gt;, wk39 &lt;dbl&gt;, wk40 &lt;dbl&gt;,
## #   wk41 &lt;dbl&gt;, wk42 &lt;dbl&gt;, wk43 &lt;dbl&gt;, wk44 &lt;dbl&gt;, wk45 &lt;dbl&gt;, wk46 &lt;dbl&gt;,
## #   wk47 &lt;dbl&gt;, wk48 &lt;dbl&gt;, wk49 &lt;dbl&gt;, wk50 &lt;dbl&gt;, wk51 &lt;dbl&gt;, wk52 &lt;dbl&gt;,
## #   wk53 &lt;dbl&gt;, wk54 &lt;dbl&gt;, wk55 &lt;dbl&gt;, wk56 &lt;dbl&gt;, wk57 &lt;dbl&gt;, wk58 &lt;dbl&gt;,
## #   wk59 &lt;dbl&gt;, wk60 &lt;dbl&gt;, wk61 &lt;dbl&gt;, wk62 &lt;dbl&gt;, wk63 &lt;dbl&gt;, wk64 &lt;dbl&gt;,
## #   wk65 &lt;dbl&gt;, wk66 &lt;lgl&gt;, wk67 &lt;lgl&gt;, wk68 &lt;lgl&gt;, wk69 &lt;lgl&gt;, wk70 &lt;lgl&gt;,
## #   wk71 &lt;lgl&gt;, wk72 &lt;lgl&gt;, wk73 &lt;lgl&gt;, wk74 &lt;lgl&gt;, wk75 &lt;lgl&gt;, wk76 &lt;lgl&gt;
```

---
## `pivot_longer()`


```r
billboard %&gt;%
 pivot_longer(
   cols = starts_with("wk"),
   names_to = "week",
   names_prefix = "wk",
   values_to = "rank",
   values_drop_na = TRUE
 )
```

```
## # A tibble: 5,307 x 5
##    artist  track                   date.entered week   rank
##    &lt;chr&gt;   &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 2 Pac   Baby Don't Cry (Keep... 2000-02-26   1        87
##  2 2 Pac   Baby Don't Cry (Keep... 2000-02-26   2        82
##  3 2 Pac   Baby Don't Cry (Keep... 2000-02-26   3        72
##  4 2 Pac   Baby Don't Cry (Keep... 2000-02-26   4        77
##  5 2 Pac   Baby Don't Cry (Keep... 2000-02-26   5        87
##  6 2 Pac   Baby Don't Cry (Keep... 2000-02-26   6        94
##  7 2 Pac   Baby Don't Cry (Keep... 2000-02-26   7        99
##  8 2Ge+her The Hardest Part Of ... 2000-09-02   1        91
##  9 2Ge+her The Hardest Part Of ... 2000-09-02   2        87
## 10 2Ge+her The Hardest Part Of ... 2000-09-02   3        92
## # … with 5,297 more rows
```

---
## `pivot_wider()`

Let's load the `fish_encounters` data from tidyverse.


```r
data(fish_encounters)
head(fish_encounters)
```

```
## # A tibble: 6 x 3
##   fish  station  seen
##   &lt;fct&gt; &lt;fct&gt;   &lt;int&gt;
## 1 4842  Release     1
## 2 4842  I80_1       1
## 3 4842  Lisbon      1
## 4 4842  Rstr        1
## 5 4842  Base_TD     1
## 6 4842  BCE         1
```

---

## `pivot_wider()`

We can use `pivot_wider()` to go from data in "long" form to data in "wide" form.


```r
fish_encounters %&gt;%
  pivot_wider(names_from = station, values_from = seen)
```

```
## # A tibble: 19 x 12
##    fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW
##    &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 4842        1     1      1     1       1     1     1     1     1     1     1
##  2 4843        1     1      1     1       1     1     1     1     1     1     1
##  3 4844        1     1      1     1       1     1     1     1     1     1     1
##  4 4845        1     1      1     1       1    NA    NA    NA    NA    NA    NA
##  5 4847        1     1      1    NA      NA    NA    NA    NA    NA    NA    NA
##  6 4848        1     1      1     1      NA    NA    NA    NA    NA    NA    NA
##  7 4849        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
##  8 4850        1     1     NA     1       1     1     1    NA    NA    NA    NA
##  9 4851        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 10 4854        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 11 4855        1     1      1     1       1    NA    NA    NA    NA    NA    NA
## 12 4857        1     1      1     1       1     1     1     1     1    NA    NA
## 13 4858        1     1      1     1       1     1     1     1     1     1     1
## 14 4859        1     1      1     1       1    NA    NA    NA    NA    NA    NA
## 15 4861        1     1      1     1       1     1     1     1     1     1     1
## 16 4862        1     1      1     1       1     1     1     1     1    NA    NA
## 17 4863        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 18 4864        1     1     NA    NA      NA    NA    NA    NA    NA    NA    NA
## 19 4865        1     1      1    NA      NA    NA    NA    NA    NA    NA    NA
```


---

## `pivot_wider()`


```r
fish_encounters %&gt;%
  pivot_wider(
    names_from = station,
    values_from = seen,
    values_fill = list(seen = 0)
  )
```

```
## # A tibble: 19 x 12
##    fish  Release I80_1 Lisbon  Rstr Base_TD   BCE   BCW  BCE2  BCW2   MAE   MAW
##    &lt;fct&gt;   &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 4842        1     1      1     1       1     1     1     1     1     1     1
##  2 4843        1     1      1     1       1     1     1     1     1     1     1
##  3 4844        1     1      1     1       1     1     1     1     1     1     1
##  4 4845        1     1      1     1       1     0     0     0     0     0     0
##  5 4847        1     1      1     0       0     0     0     0     0     0     0
##  6 4848        1     1      1     1       0     0     0     0     0     0     0
##  7 4849        1     1      0     0       0     0     0     0     0     0     0
##  8 4850        1     1      0     1       1     1     1     0     0     0     0
##  9 4851        1     1      0     0       0     0     0     0     0     0     0
## 10 4854        1     1      0     0       0     0     0     0     0     0     0
## 11 4855        1     1      1     1       1     0     0     0     0     0     0
## 12 4857        1     1      1     1       1     1     1     1     1     0     0
## 13 4858        1     1      1     1       1     1     1     1     1     1     1
## 14 4859        1     1      1     1       1     0     0     0     0     0     0
## 15 4861        1     1      1     1       1     1     1     1     1     1     1
## 16 4862        1     1      1     1       1     1     1     1     1     0     0
## 17 4863        1     1      0     0       0     0     0     0     0     0     0
## 18 4864        1     1      0     0       0     0     0     0     0     0     0
## 19 4865        1     1      1     0       0     0     0     0     0     0     0
```


---
## `pivot_wider()`

Let's load the `us_rent_income` data from tidyverse.


```r
data(us_rent_income)
head(us_rent_income)
```

```
## # A tibble: 6 x 5
##   GEOID NAME    variable estimate   moe
##   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
## 1 01    Alabama income      24476   136
## 2 01    Alabama rent          747     3
## 3 02    Alaska  income      32940   508
## 4 02    Alaska  rent         1200    13
## 5 04    Arizona income      27517   148
## 6 04    Arizona rent          972     4
```

---

## `pivot_wider()`


```r
us_rent_income %&gt;%
  pivot_wider(names_from = variable, values_from = c(estimate, moe))
```

```
## # A tibble: 52 x 6
##    GEOID NAME                 estimate_income estimate_rent moe_income moe_rent
##    &lt;chr&gt; &lt;chr&gt;                          &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;
##  1 01    Alabama                        24476           747        136        3
##  2 02    Alaska                         32940          1200        508       13
##  3 04    Arizona                        27517           972        148        4
##  4 05    Arkansas                       23789           709        165        5
##  5 06    California                     29454          1358        109        3
##  6 08    Colorado                       32401          1125        109        5
##  7 09    Connecticut                    35326          1123        195        5
##  8 10    Delaware                       31560          1076        247       10
##  9 11    District of Columbia           43198          1424        681       17
## 10 12    Florida                        25952          1077         70        3
## # … with 42 more rows
```

---
layout: false
layout: true

# Joining Data

---

We can use SQL-like join statements in R!


* `inner_join(x, y, by = "key")`: match observations only when exact keys are equal
* `left_join(x, y, by = "key")`: keep all observations in `x`, match observations in `y` by keys, `NA` otherwise
* `right_join(x, y, by = "key")`: keep all observations in `y`, match observations in `x` by keys, `NA` otherwise
* `outer_join(x, y, by = "key")`: keep all observations in `x` and `y`, match keys where possible, `NA` otherwise


.footnote[Usually, `left_join()` will suffice!]

---

.center[&lt;img src="join-inner.png" alt="" height="100"/&gt;]
.center[&lt;img src="join-outer.png" alt="" height="380"/&gt;]


.footnote[Images courtesy of Hadley Wickham. ([Link](https://r4ds.had.co.nz/relational-data.html))]

---
layout: false

# dplyr cheatsheet

* `filter()` subset rows
* `select()` subset columns, use with `contains()`, `starts_with()`, `ends_with()`, ...
* `mutate()` create columns
* `group_by()`, `summarize()`, `count()` group and summarize groups
* `rename()` rename columns
* `pivot_longer()`, `pivot_wider()` reshape data
* `inner_join()`, `left_join()`, `right_join()`, `outer_join()` combine data (like SQL)

.pushdown[.center[[Much, much more! (Click me for a cheat sheet!)](https://rstudio.com/resources/cheatsheets/)]]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "tomorrow-night-bright",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
